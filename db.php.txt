<?php
//connect database
$con = mysqli_connect("localhost", "root", "", "vsu_i_ris");
    if (!$con)
        exit(mysqli_connect_error());

//create table users
if (!$con->query('create table users(
            u_id int(12) auto_increment primary key, 
            u_name varchar(32) not null, 
            u_pass varchar(72) not null, 
            fname varchar(32) not null, 
            lname varchar(32) not null, 
            gender enum("Male","Female") not null, 
            cnumber varchar(32) not null, 
            email varchar(32) not null, 
            role varchar(32) not null,
            img_file varchar(32) default "blank.jpg",
            status enum("ACTIVE","DISABLED") not null)'))
    echo mysqli_error($con);

//create table login_tracker
if(!$con->query('create table login_tracker(
            u_id int(12) not null,
            session_id varchar(32) not null,
            remote_ip varchar(32) not null,
            user_agent varchar(32) not null,
            last_activity datetime default current_timestamp on update current_timestamp,
            attempts int(2) DEFAULT 0,
            unlock_time varchar(32) DEFAULT 0,
            foreign key(u_id) references users(u_id))'))
    echo mysqli_error($con);
//create pending_reg table
if(!$con->query('create table pending_registration(
            reg_id int(12) auto_increment primary key, 
            email varchar(32) not null, 
            reg_code varchar(72) not null,
            role varchar(32) not null)'))
    echo mysqli_error($con);
//create pending_reg_tracker table
if(!$con->query('create table pending_registration_tracker(
            reg_id int(12) not null,
            session_id varchar(32) not null,
            remote_ip varchar(32) not null,
            user_agent varchar(32) not null,
            last_activity datetime default current_timestamp on update current_timestamp,
            attempts int(2) DEFAULT 0,
            unlock_time varchar(32) DEFAULT 0,
            foreign key(reg_id) references pending_registration(reg_id))'))
    echo mysqli_error($con);
//create pending forgot pass table            
if(!$con->query('create table pending_forgot_pass(
            id int(12) PRIMARY KEY AUTO_INCREMENT, 
            u_id int(12) not null, 
            cooldown_time varchar(32) not null,
            FOREIGN KEY(u_id) REFERENCES users(u_id))'))
    echo mysqli_error($con);
//create patients table            
if(!$con->query('create table patients(
            id int(12) PRIMARY KEY AUTO_INCREMENT, 
            fname varchar(32) not null,
            lname varchar(32) not null,
            gender enum("Male", "Female") not null,
            cnumber varchar(32) null,
            '))
    echo mysqli_error($con);
//create examination table        
if(!$con->query('create table examination(
            x_ray_no int(12) PRIMARY KEY not null,
            patient_id int(12) not null,
            clinical_history varchar(32) not null,
            requesting_physician varchar(32) not null,
            film_size enum("8x10", "10x14", "14x14", "14x17") not null,
            FOREIGN KEY(patient_id) REFERENCES patients(id),
            '))
    echo mysqli_error($con);
//create for_reading table        
if(!$con->query('create table for_reading(
            id int(12) PRIMARY KEY auto_increment,
            patient_id int(12) not null,
            x_ray_no int(12) not null,
            x_ray_img varchar(32) not null,
            FOREIGN KEY(patient_id) REFERENCES patients(id),
            FOREIGN KEY(x_ray_no) REFERENCES examination(x_ray_no),
            '))
    echo mysqli_error($con);
//create findings_and_diagnoses table        
if(!$con->query('create table findings_and_diagnoses(
            id int(12) PRIMARY KEY auto_increment,
            findings varchar(300) not null,
            diagnosis varchar(150) not null,
            '))
    echo mysqli_error($con);
//create x_ray_results table        
if(!$con->query('create table x_ray_results(
            id int(12) PRIMARY KEY auto_increment,
            patient_id int(12) not null,
            x_ray_no int(12) not null,
            findings_and_diagnoses_id int(12) not null,
            FOREIGN KEY(findings_and_diagnoses_id) REFERENCES findings_and_diagnoses(id),
            FOREIGN KEY(patient_id) REFERENCES patients(id),
            FOREIGN KEY(x_ray_no) REFERENCES examination(x_ray_no),
            '))
    echo mysqli_error($con);


//populate table
//create account for admin
$hashadmin = password_hash("admin", PASSWORD_BCRYPT, array('cost' => 10));
$con->query('insert into users
    (u_name, u_pass, fname, lname, gender, cnumber, email, role, status) 
    values 
    ("admin", "'.$hashadmin.'", "First name", "Lastname", "Male", "Add a contact #", "Add an email", "admin", "ACTIVE")');
?>