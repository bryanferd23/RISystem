<?php
//connect
$con = mysqli_connect("localhost", "root", "");
    if (!$con)
        exit(mysqli_connect_error());


//drop db
if (!$con->query('drop database if exists vsu_i_ris'))
    echo mysqli_error($con);
//create db db
if (!$con->query('create database vsu_i_ris'))
echo mysqli_error($con);
//connect to db
$con = mysqli_connect("localhost", "root", "", "vsu_i_ris");
    if (!$con)
        exit(mysqli_connect_error());
//-------------------------- USER related tables -----------------------------------------------------------//
//USERS
if (!$con->query('create table users(
            u_id int(12) auto_increment primary key, 
            u_name varchar(32) not null, 
            u_pass varchar(72) not null, 
            fname varchar(32) not null, 
            lname varchar(32) not null, 
            gender enum("Male","Female") not null, 
            cnumber varchar(32) not null, 
            email varchar(32) not null, 
            role varchar(32) not null,
            img_file varchar(32) default "blank.jpg",
            status enum("ACTIVE","DISABLED") not null)'))
    echo mysqli_error($con);

//login_tracker
if(!$con->query('create table login_tracker(
            u_id int(12) not null,
            session_id varchar(32) not null,
            remote_ip varchar(32) not null,
            user_agent varchar(32) not null,
            last_activity datetime default current_timestamp on update current_timestamp,
            attempts int(2) DEFAULT 0,
            unlock_time varchar(32) DEFAULT 0,
            foreign key(u_id) references users(u_id))'))
    echo mysqli_error($con);
//pending_reg
if(!$con->query('create table pending_registration(
            reg_id int(12) auto_increment primary key, 
            email varchar(32) not null, 
            reg_code varchar(72) not null,
            role varchar(32) not null)'))
    echo mysqli_error($con);
//pending_reg_tracker
if(!$con->query('create table pending_registration_tracker(
            reg_id int(12) not null,
            session_id varchar(32) not null,
            remote_ip varchar(32) not null,
            user_agent varchar(32) not null,
            last_activity datetime default current_timestamp on update current_timestamp,
            attempts int(2) DEFAULT 0,
            unlock_time varchar(32) DEFAULT 0,
            foreign key(reg_id) references pending_registration(reg_id))'))
    echo mysqli_error($con);
//pending forgot pass          
if(!$con->query('create table pending_forgot_pass(
            id int(12) PRIMARY KEY AUTO_INCREMENT, 
            u_id int(12) not null, 
            cooldown_time varchar(32) not null,
            FOREIGN KEY(u_id) REFERENCES users(u_id))'))
    echo mysqli_error($con);

//--------------------------------=--- patient, physician, x-ray related tables -----------------------------------------------------//
//unnormalized
//x_ray_no, inf_no, or_no, b_date, name, age, status_or_standing, procedure, history_or_purpose, film_sizes, no_of_spoilage, reason_for_spoilage, physician, c_number, released

//physician,   
if(!$con->query('create table physicians(
            id int(12) PRIMARY KEY AUTO_INCREMENT, 
            fname varchar(32) not null,
            lname varchar(32) not null,
            specialization varchar(100) not null)
            '))
    echo mysqli_error($con);

//b_date, name, age, status_or_standing, c_number,
if(!$con->query('create table patients(
            id int(12) PRIMARY KEY AUTO_INCREMENT, 
            fname varchar(32) not null,
            lname varchar(32) not null,
            b_date date not null,
            age int(3) not null,
            gender enum("Male", "Female") not null,
            standing_or_status enum("Dependent", "Employee", "Student", "Outsider"),
            cnumber varchar(32) null)
            '))
    echo mysqli_error($con);

//x_ray_no, inf_no, or_no, history_or_purpose, no_of_film_spoilage, reason_for_spoilage, released
if(!$con->query('create table examination(
            x_ray_no varchar(12) PRIMARY KEY not null,
            inf_no int(12) not null,
            or_no int(12) not null,
            date date not null,
            patient_id int(12) not null,
            history_or_purpose varchar(32) not null,
            physician_id int(12) not null,
            no_of_film_spoilage int(2) null,
            reason_for_spoilage varchar(32) null,
            FOREIGN KEY(physician_id) REFERENCES physicians(id),
            FOREIGN KEY(patient_id) REFERENCES patients(id))
            '))
    echo mysqli_error($con);

//procedure, film_sizes
if(!$con->query('create table procedures(
            id int(12) PRIMARY KEY AUTO_INCREMENT, 
            x_ray_no varchar(12) not null,
            type enum("Chest", "Extremities", "Skull", "Vertebrae", "Shoulder", "Abdomin", "Bucky") not null,
            views enum("AP","PA","APL","PAL","APOL","PALO","RAO","LAO","FPU","Internal Rotation","External Rotation","Waters view","Scapular Y") not null,
            film_size enum("8x10", "10x12", "11x14", "14x14", "14x17") not null,
            foreign key(x_ray_no) references examination(x_ray_no))
            '))
    echo mysqli_error($con);

//radiographs
if(!$con->query('create table radiographs(
            procedure_id int(12) not null,
            img_file varchar(32) not null,
            FOREIGN key(procedure_id) references procedures(id))
            '))
    echo mysqli_error($con);

//for_reading
if(!$con->query('create table for_reading(
            id int(12) PRIMARY KEY auto_increment,
            x_ray_no varchar(12) not null,
            FOREIGN KEY(x_ray_no) REFERENCES examination(x_ray_no))
            '))
    echo mysqli_error($con);

//findings_and_diagnoses      
if(!$con->query('create table findings_and_diagnoses(
            id int(12) PRIMARY KEY auto_increment,
            findings varchar(300) not null,
            diagnosis varchar(150) not null)
            '))
    echo mysqli_error($con);

//x_ray_results      
if(!$con->query('create table x_ray_results(
            procedure_id int(12) not null,
            findings_and_diagnoses_id int(12) not null,
            FOREIGN KEY(findings_and_diagnoses_id) REFERENCES findings_and_diagnoses(id),
            FOREIGN KEY(procedure_id) REFERENCES procedures(id))
            '))
    echo mysqli_error($con);


//------------------ populate tables -------------------------------------------------------------------------//
$hashadmin = password_hash("admin", PASSWORD_BCRYPT, array('cost' => 10));
$hashradtech = password_hash("radtechmai2", PASSWORD_BCRYPT, array('cost' => 10));
$con->query('insert into users
    (u_name, u_pass, fname, lname, gender, cnumber, email, role, status, img_file) 
    values 
    ("admin", "'.$hashadmin.'", "Ferdiwil", "Perante", "Male", "9055426718", "ris.email.system@gmail.com", "admin", "ACTIVE", "1.jpg"),
    ("radtechmai2", "'.$hashradtech.'", "Lainely Mai", "Bandilla", "Female", "9120984652", "aeonette24@gmail.com", "Radiologic technologist", "ACTIVE", "2.jpeg")');

$con->query('insert into physicians
    (fname, lname, specialization)
    values 
    ("Elwin Jay", "Yu", "Internal Medicine"),
    ("Merry Christ\'l", "Supnet-guinocor", "Pediatrician")');


$con->query('INSERT INTO patients
(fname, lname, b_date, age, gender, standing_or_status, cnumber) 
values
("ferdiwil","perante","1990-07-02",30,"Male","Student","9614359029")');
$con->query('INSERT INTO examination
(x_ray_no, inf_no, or_no, date, patient_id, history_or_purpose, physician_id) 
values
("12-1212","15235","52351","2021-04-20",1,"P.E",1)');
$con->query('INSERT INTO procedures
(x_ray_no, type, views, film_size) 
values
("12-1212","Chest","PA","14x14")');

$con->query('INSERT INTO patients
(fname, lname, b_date, age, gender, standing_or_status, cnumber) 
values
("lainely","bandilla","1990-07-02",30,"Female","Employee","9614359029")');
$con->query('INSERT INTO examination
(x_ray_no, inf_no, or_no, date, patient_id, history_or_purpose, physician_id) 
values
("12-1213","15234","52353","2021-04-20",1,"renewal",1)');
$con->query('INSERT INTO procedures
(x_ray_no, type, views, film_size) 
values
("12-1213","Chest","PA","11x14")');
?>


